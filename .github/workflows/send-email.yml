name: CI/CD Send GitHub Notification

on:
  workflow_run:
    workflows: ["CI/CD On Push Workflow"]
    branches: [main]
    types: 
      - completed

jobs:
  dummy-job:
    runs-on: ubuntu-latest
    steps:
      - name: Dummy Step
        run: echo "This is a dummy job"

  get-result:  # Add the get-result job here
    runs-on: ubuntu-latest
    outputs:
      test_result: ${{ steps.get-result-output.outputs.test_result }}
    permissions: write-all
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Run Test Scenarios
        run: echo "Running tests..."
      - name: Get Results
        id: get-result-output
        run: echo "::set-output name=test_result::Test result from get-result job"

  read-pull-request:
    runs-on: ubuntu-latest
    permissions: write-all
    needs: [dummy-job, get-result]  # Specify the dependency on the dummy job and get-result job
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Get last pull request number
        id: get-pr-number
        run: |
          pr_number=$(git log -1 --pretty=format:%s | grep -oP '#\d+')
          pr_number=${pr_number//#/}  # Remove '#' symbol
          echo "::set-output name=pr_number::$pr_number"    
          
      - name: Print pull request number
        run: echo "Last pull request number is ${{ steps.get-pr-number.outputs.pr_number }}"
      
      - name: Print Test Results
        run: |
          echo "${{ needs.get-result.outputs.test_result }}"
     
      - name: Add Comment
        uses: actions/github-script@v5
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ steps.get-pr-number.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Test'
            })
